apiVersion: apps/v1
kind: Deployment
metadata:
  name: claude-code-agent
  namespace: claude-agent
  labels:
    app: claude-code-agent
spec:
  replicas: 1
  strategy:
    type: Recreate  # Single replica, avoid PVC conflicts
  selector:
    matchLabels:
      app: claude-code-agent
  template:
    metadata:
      labels:
        app: claude-code-agent
    spec:
      initContainers:
      - name: init-claude
        image: node:20-slim
        command:
        - /bin/bash
        - -c
        - |
          # Copy credentials from secret to writable directory
          mkdir -p /home/node/.claude
          if [ -f /claude-creds/.credentials.json ]; then
            cp /claude-creds/.credentials.json /home/node/.claude/
            cp /claude-creds/settings.json /home/node/.claude/ 2>/dev/null || true
            echo "Credentials copied successfully"
          else
            echo "No credentials found - Claude CLI will need authentication"
          fi
          # Set ownership
          chown -R 1000:1000 /home/node/.claude
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        securityContext:
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - name: claude-session-secret
          mountPath: /claude-creds
          readOnly: true
        - name: claude-home
          mountPath: /home/node/.claude
      containers:
      - name: agent
        image: node:20-slim
        command:
        - /bin/bash
        - -c
        - |
          # Configure npm to install globally to user directory
          mkdir -p /home/node/.npm-global
          npm config set prefix '/home/node/.npm-global'
          export PATH="/home/node/.npm-global/bin:$PATH"

          # Install Claude Code CLI
          npm install -g @anthropic-ai/claude-code

          # Verify installation
          echo "PATH=$PATH"
          /home/node/.npm-global/bin/claude --version || echo "Claude CLI not found"

          # Create HTTP server wrapper
          cat > /home/node/server.js << 'SERVEREOF'
          const http = require('http');
          const { spawnSync } = require('child_process');

          const PORT = 3000;
          const CLAUDE_PATH = '/home/node/.npm-global/bin/claude';

          const server = http.createServer((req, res) => {
            // Health check
            if (req.method === 'GET' && req.url === '/health') {
              res.writeHead(200, { 'Content-Type': 'application/json' });
              res.end(JSON.stringify({ status: 'healthy', timestamp: new Date().toISOString() }));
              return;
            }

            // Run Claude
            if (req.method === 'POST' && req.url === '/run') {
              let body = '';
              req.on('data', chunk => body += chunk);
              req.on('end', () => {
                try {
                  const { prompt, max_turns = 1, timeout = 300 } = JSON.parse(body);
                  if (!prompt) {
                    res.writeHead(400, { 'Content-Type': 'application/json' });
                    res.end(JSON.stringify({ error: 'prompt is required' }));
                    return;
                  }

                  console.log(`[${new Date().toISOString()}] Running prompt: ${prompt.substring(0, 50)}...`);

                  const args = ['-p', prompt, '--max-turns', String(max_turns)];
                  const result = spawnSync(CLAUDE_PATH, args, {
                    timeout: timeout * 1000,
                    maxBuffer: 10 * 1024 * 1024,
                    encoding: 'utf8',
                    env: process.env
                  });

                  const exitCode = result.status ?? 1;
                  console.log(`[${new Date().toISOString()}] Exit code: ${exitCode}`);

                  res.writeHead(exitCode === 0 ? 200 : 500, { 'Content-Type': 'application/json' });
                  res.end(JSON.stringify({
                    exit_code: exitCode,
                    stdout: (result.stdout || '').trim(),
                    stderr: (result.stderr || '').trim(),
                    timestamp: new Date().toISOString()
                  }));
                } catch (e) {
                  res.writeHead(400, { 'Content-Type': 'application/json' });
                  res.end(JSON.stringify({ error: 'Invalid JSON: ' + e.message }));
                }
              });
              return;
            }

            res.writeHead(404, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: 'Not found' }));
          });

          server.listen(PORT, '0.0.0.0', () => {
            console.log(`Claude Agent HTTP server listening on port ${PORT}`);
          });
          SERVEREOF

          echo "Starting HTTP server..."
          exec node /home/node/server.js
        env:
        - name: HOME
          value: /home/node
        - name: NODE_ENV
          value: production
        - name: PATH
          value: /home/node/.npm-global/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        volumeMounts:
        - name: claude-home
          mountPath: /home/node/.claude
        - name: workspace
          mountPath: /workspace
        ports:
        - containerPort: 3000
          name: http
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "4Gi"
            cpu: "2"
        workingDir: /workspace
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          seccompProfile:
            type: RuntimeDefault
      volumes:
      - name: claude-session-secret
        secret:
          secretName: claude-session
          optional: true  # Allow deployment without secret initially
      - name: claude-home
        emptyDir:
          sizeLimit: 1Gi
      - name: workspace
        emptyDir:
          sizeLimit: 5Gi
