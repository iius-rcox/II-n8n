# k8s/secrets/external-secrets/argocd-external-secret.yaml
# =============================================================================
# ExternalSecret for ArgoCD Admin Password
# =============================================================================
# This ExternalSecret syncs the ArgoCD admin password from Azure Key Vault
# to a Kubernetes Secret in the argocd namespace.
#
# PREREQUISITES:
# 1. ClusterSecretStore 'azure-keyvault' is configured and Ready
# 2. Secret 'argocd-admin-password' exists in Azure Key Vault
# 3. argocd namespace exists with ArgoCD installed
#
# NOTE: This supplements the auto-generated argocd-initial-admin-secret.
# For production, you may want to disable the auto-generated secret
# and use this AKV-managed secret exclusively.
# =============================================================================
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: argocd-admin-secret
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd
    app.kubernetes.io/part-of: argocd
    app.kubernetes.io/component: secrets
spec:
  # Refresh interval - how often to sync from AKV
  refreshInterval: 4h

  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: azure-keyvault
    kind: ClusterSecretStore

  # Target Kubernetes Secret configuration
  target:
    name: argocd-secret
    creationPolicy: Merge
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: argocd-secret
          app.kubernetes.io/part-of: argocd
          managed-by: external-secrets

  # Data mapping from AKV to K8s Secret
  data:
    # ArgoCD admin password (bcrypt hashed)
    # The password in AKV should be bcrypt hashed
    # Generate with: htpasswd -nbBC 10 "" 'yourpassword' | tr -d ':\n' | sed 's/$2y/$2a/'
    - secretKey: admin.password
      remoteRef:
        key: argocd-admin-password
