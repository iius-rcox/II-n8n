# k8s/secrets/external-secrets/n8n-external-secret.yaml
# =============================================================================
# ExternalSecret for n8n Application Secrets
# =============================================================================
# This ExternalSecret syncs the n8n encryption key from Azure Key Vault
# to a Kubernetes Secret in the n8n-prod namespace.
#
# PREREQUISITES:
# 1. ClusterSecretStore 'azure-keyvault' is configured and Ready
# 2. Secret 'n8n-encryption-key' exists in Azure Key Vault
# 3. n8n-prod namespace exists
#
# The synced secret will replace the manual k8s/secrets/n8n-secrets.yaml
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: n8n-secrets
  namespace: n8n-prod
  labels:
    app: n8n
    environment: production
    app.kubernetes.io/name: n8n
    app.kubernetes.io/component: secrets
spec:
  # Refresh interval - how often to sync from AKV
  # 4 hours balances security with API costs
  refreshInterval: 4h

  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: azure-keyvault
    kind: ClusterSecretStore

  # Target Kubernetes Secret configuration
  target:
    name: n8n-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app: n8n
          environment: production
          managed-by: external-secrets

  # Data mapping from AKV to K8s Secret
  data:
    # n8n encryption key - maps AKV secret to K8s secret key
    - secretKey: N8N_ENCRYPTION_KEY
      remoteRef:
        key: n8n-encryption-key
        # Optional: specify version or use latest
        # version: "latest"
