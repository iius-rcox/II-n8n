# k8s/secrets/external-secrets/secret-store.yaml
# =============================================================================
# ClusterSecretStore for Azure Key Vault
# =============================================================================
# This ClusterSecretStore provides cluster-wide access to Azure Key Vault
# using Workload Identity authentication. All ExternalSecret resources
# in any namespace can reference this store.
#
# PREREQUISITES:
# 1. External Secrets Operator installed
# 2. Azure Key Vault created with RBAC authorization
# 3. Managed Identity with Key Vault Secrets User role
# 4. ServiceAccount with Workload Identity annotation (service-account.yaml)
#
# REQUIRED CONFIGURATION:
# - Replace ${KEYVAULT_NAME} with your actual Key Vault name (e.g., ii-n8n-secrets)
# =============================================================================
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: azure-keyvault
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
spec:
  provider:
    azurekv:
      # Authentication method: Workload Identity (recommended for AKS)
      authType: WorkloadIdentity

      # Azure Tenant ID
      tenantId: "953922e6-5370-4a01-a3d5-773a30df726b"

      # Azure Key Vault URL - Replace ${KEYVAULT_NAME} with actual name
      # Example: https://ii-n8n-secrets.vault.azure.net
      vaultUrl: "https://iius-akv.vault.azure.net"

      # Reference to ServiceAccount configured with Workload Identity
      serviceAccountRef:
        name: external-secrets-sa
        namespace: external-secrets
