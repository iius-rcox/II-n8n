# Implementation Plan: ArgoCD Web UI Setup and Azure Key Vault Secrets Migration

**Branch**: `002-argocd-ui-akv-secrets` | **Date**: 2025-12-16 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-argocd-ui-akv-secrets/spec.md`

## Summary

This feature enables secure access to the ArgoCD web UI for GitOps management and migrates application secrets from Kubernetes native secrets to Azure Key Vault (AKV). The implementation uses Azure Web App Routing ingress controller (already configured for n8n), External Secrets Operator for AKV integration, and cert-manager for TLS certificates. ArgoCD authentication will use local accounts with the admin password stored in AKV.

## Technical Context

**Language/Version**: YAML (Kubernetes manifests), Bash (scripts)
**Primary Dependencies**: ArgoCD, External Secrets Operator, Azure Key Vault CSI Driver, cert-manager, Azure Web App Routing ingress
**Storage**: Azure Key Vault (secrets), Azure Managed Disks (existing PVCs)
**Testing**: kubectl validation, ArgoCD sync status, manual UI verification
**Target Platform**: Azure Kubernetes Service (AKS)
**Project Type**: Infrastructure/GitOps configuration
**Performance Goals**: ArgoCD UI accessible within 30 seconds, secrets sync within 5 minutes
**Constraints**: TLS required, no anonymous access, secrets must not exist in plain Kubernetes manifests
**Scale/Scope**: Single ArgoCD instance, 1-5 concurrent UI users, n8n application secrets

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Note**: Constitution file contains template placeholders only. Applying infrastructure best practices:

| Principle | Status | Notes |
|-----------|--------|-------|
| GitOps-First | PASS | All manifests stored in Git, ArgoCD manages deployment |
| Secrets Management | PASS | Using External Secrets Operator with AKV, no plain secrets in Git |
| TLS Everywhere | PASS | cert-manager + Let's Encrypt for TLS, SSL redirect enforced |
| Least Privilege | PASS | AKS Managed Identity for AKV access, RBAC-scoped |
| Infrastructure as Code | PASS | All resources defined in Kustomize manifests |

## Project Structure

### Documentation (this feature)

```text
specs/002-argocd-ui-akv-secrets/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
# Existing Infrastructure (reference)
k8s/
├── namespace.yaml
├── kustomization.yaml
├── secrets/
│   └── n8n-secrets.yaml          # To be replaced by ExternalSecret
├── deployment/
│   ├── n8n-deployment.yaml       # Will reference AKV-synced secrets
│   ├── n8n-ingress.yaml
│   └── ...
└── ...

# New ArgoCD UI Configuration
argocd/
├── kustomization.yaml            # ArgoCD namespace resources
├── ingress.yaml                  # ArgoCD server ingress with TLS
├── argocd-cm.yaml               # ConfigMap for server settings
└── argocd-rbac-cm.yaml          # RBAC configuration

# New External Secrets Configuration
k8s/secrets/
├── external-secrets/
│   ├── secret-store.yaml         # ClusterSecretStore for AKV
│   ├── n8n-external-secret.yaml  # ExternalSecret for n8n
│   └── argocd-external-secret.yaml # ExternalSecret for ArgoCD admin

# Azure Infrastructure (documentation only - provisioned via Azure CLI/Portal)
docs/
└── azure-setup.md                # Azure Key Vault and identity setup
```

**Structure Decision**: Using existing k8s/ directory structure with new subdirectories for External Secrets resources. ArgoCD server configuration in separate argocd/ directory to maintain separation from application workloads.

## Complexity Tracking

> No constitution violations requiring justification.

## Implementation Phases

### Phase 0: Research & Prerequisites

1. Research External Secrets Operator vs Azure Key Vault CSI Driver
2. Determine ArgoCD ingress configuration for Azure Web App Routing
3. Identify existing secrets requiring migration to AKV
4. Research cert-manager integration for ArgoCD TLS

### Phase 1: Design & Contracts

1. Define Azure Key Vault secret structure
2. Design ExternalSecret CRDs for n8n and ArgoCD
3. Define ArgoCD ingress configuration
4. Design secret rotation strategy

### Phase 2: Implementation Tasks

*(Generated by /speckit.tasks command)*
